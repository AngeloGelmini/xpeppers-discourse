# Ansible-discourse

Provisioning [Discourse](https://github.com/discourse/discourse) with Vagrant, Ansible, [Discourse Docker](https://github.com/discourse/discourse_docker) and AWS.

* For the installation on AWS see section [Deployment on AWS](#deployment-on-aws)
* For local installation with vagrant see section [Local Deployment with Vagrant](#local-deployment-with-vagrant)

# Local Deployment with Vagrant

## Requirements

* Vagrant (tested with *1.8.1*)
* Ansible (tested with *1.9.3*)


## Basic Setup

1) Clone this project:

```
git clone --recursive git@github.com:xpeppers/ansible-discourse.git
```

2) Add an entry to your `/etc/hosts` file that maps the domain `discourse.dev` to the IP of the virtual machine:

```
192.168.11.3    discourse.dev
```

3) Start the virtual machine with vagrant:

```
vagrant up
```

4) Install the ansible roles (execute from the host machine):

```
[sudo] ansible-galaxy install -r requirements.yml
```

5) Edit playbooks/roles/discourse/files/app.yml file filling <> parameters:

6) (Optional) Configure backup:

```
cp playbooks/roles/discourse/files/backup.cron.template.sh playbooks/roles/discourse/files/backup.cron.sh
```

Fill the API key in `backup.cron.sh` with the key you find here: https://<DISCOURSE_HOST>/admin/api/keys

7) (Optional) If you want to change the default (`/var/discourse`) installation directory of Discourse, you can change the value in `playbooks/vars/main.yml` and change the value of volumes in `app.yml` too.


## Provisioning

Provision with

```
# Vagrant host
scripts/provision_vagrant
# or
scripts/provision_vagrant_only_machine
# or
scripts/provision_vagrant_only_discourse

# AWS host
scripts/provision_aws
# or
scripts/provision_aws_only_machine
```


## Utility scripts

### Manual/Automatic Backups

Run this command to trigger a backup:

```
scripts/cmd_aws "sudo sh /home/discourse/backup.cron.sh"
```

Additionally there is a cron configured that runs automatic backups at 9:00, 14:00 and 20:00. For additional configuration see `playbooks/roles/discourse/tasks/main.yml`.



### Gather info about the machine

```
scripts/info_vagrant

# or

scripts/info_aws
```



### Machine logs

```
scripts/logs_vagrant

# or

scripts/logs_aws
```

### Execute arbitrary commands

```
scripts/cmd_aws "ls -lh /var/discourse"
scripts/cmd_aws "sudo docker ps"

scripts/cmd_aws [YOUR-PEM-LOCATION] "sudo docker ps"
```

# Deployment on AWS

## Prerequisities

1. [AWS CLI](https://aws.amazon.com/cli/)
2. Have AWS access key and secret key with proper administrator permissions
3. [Packer](https://www.packer.io/)
4. [Ansible](https://www.ansible.com/) (tested with 2.3.*)

## Steps

1. Make sure to `git clone --recursive https://github.com/xpeppers/ansible-discourse.git` to fetch also all the git submodules
2. Edit the `app.yml` file and then copy it under the proper folder: ```cp app.yml ./playbooks/roles/discourse/files```
3a. Run Packer to build the AMI without assume role and MFA: ```packer build -var 'aws_access_key=<ACCESS_KEY>' -var 'aws_secret_key=<SECRET_KEY>' packer-silver-image.json```
3b. Run Packer to build the AMI with assume role and MFA: ```AWS_MFA=<mfa_code_here> AWS_PROFILE=<aws_profile_name> packer build packer-silver-image.json```
4. Take note of the AMI id created by Packer
5. Edit the `cloudformation/ec2-parameters.json` file, updating the AMI id as generated by Packer in the previous step
6. Update the stack with CloudFormation (replacing first the placeholders in this command): ```aws cloudformation update-stack --profile <AWS-PROFILE> --stack-name <STACK_NAME> --template-body file://cloudformation/ec2.yml --parameters file://cloudformation/ec2-parameters.json --region <REGION> --capabilities CAPABILITY_IAM```
7. Wait for CloudFormation to updates the stack (it should takes few minutes)

## Useful resources

* [How to create an administrator account after install](https://meta.discourse.org/t/how-to-create-an-administrator-account-after-install/14046)
* [Setting up file and image uploads to S3](https://meta.discourse.org/t/setting-up-file-and-image-uploads-to-s3/7229)
* [Setting up Discourse on AWS](http://dev.bizo.com/2014/06/discourse-on-aws.html)

## Notes

Ansibles `gather_facts` cannot be disabled.

## (Un)License

All information is public content.


# Blue-Green deployment

Steps to follow to update a new version of discourse

## Creation of green environment
1. Read-only mode on discourse: `admin->backup->Enable readonly`
2. Create RDS snapshot of the discourse database
3. Edit parameters in _rds-parameters.json_ updating the snapshot name and db version
4. Create new RDS: :warning: use the same version set before in the stack name: `aws cloudformation create-stack --profile xpeppers --stack-name discourse-rds-v10 --template-body file://rds.yml --region eu-west-1 --enable-termination-protection --capabilities CAPABILITY_NAMED_IAM --parameters file://rds-parameters.json`
5. Wait the database is created and ready :coffee:
6. Are you sure the database is ready?
7. Run packer changing AWS_MFA and DB_URL value: `AWS_PROFILE=xpeppers AWS_MFA=752390 DB_URL='discoursedb-v11.xpeppers.com.' packer build packer-silver-image.json`
8. Wait again packer finishing
9. Get the AMI id resulting in the previous packer build
10. Change parameters in _application-tier-parameters.json_: EnvironmentVersion and AMIid, using a progressive number for version and the previous command AMI id
11. Create application layer with cloudformation: :warning: use the same version set before in the stack name: `aws cloudformation create-stack --profile xpeppers --stack-name discourse-application-tier-v5 --template-body file://application-tier.yml --region eu-west-1 --capabilities CAPABILITY_NAMED_IAM --parameters file://application-tier-parameters.json`

## Testing the green environment
1. Resolve the DNS of the new create load balancer: `dig +short ALB-discourse-v5-596837878.eu-west-1.elb.amazonaws.com` and copy one of the IPs
2. Open your local _/etc/hosts_ file and append this line: `<ip_previous_command> discourse.xpeppers.com`
3. Open a new browser and try to connect to discourse.xpeppers.com checking if the answer are coming from the previous address and checking if the new version is ok
4. If ok go to the next steps

## Switching the environment
1. Go to route53 and open xpeppers.com hosted zone name
2. Change the value of record discourse.xpeppers.com setting the alias of the new load balancer version
3. Disable read-only mode and try again to pusblish something and navigate
4. Evaluate if perform a rollback or the keep the new version. This evaluation could be done in some hours of works

## Rollback
If new version doesn't work correctly revert the previous version:

1. Go to route53 and open xpeppers.com hosted zone name
2. Change the value of record discourse.xpeppers.com setting the alias of the OLD load balancer version
3. Some contents should be lost

## New version is ok
If the new version is ok and you are sure to delete the old version:

1. Delete the old application cloudformation stack
2. Delete the old RDS cloudformation stack

# Discourse operations

## Enable-Disable read mode da cli:
1. Enter into instance console
2. `cd /var/discourse`
3. `sudo ./launcher enter app`
4. `RAILS_ENV=production bundle exec rails c`
5. `Discourse.disable_readonly_mode(Discourse::USER_READONLY_MODE_KEY)`
6. [Link](https://meta.discourse.org/t/stuck-in-read-only-mode/42820)

## Change secret azure app
1. Enter into instance console
2. `cd /var/discourse`
3. `sudo ./launcher enter app`
4. `RAILS_ENV=production bundle exec rails c`
5. In the rails console:
```
s = SiteSetting.find_by(name: 'office365_secret')
s.value='<new-token>'
s.save!
```

## Change database password
The next steps are to change the password of postgres and update it directly inside container but it's temporary solution becuase the container gets password externally.
To a have a final solution you must rebuild container app.

1. Enter the instance
2. `cd /var/discourse`
3. `psql -U discourse -h <db-url>`
4. into postgres db: `\password discourse`
5. Set new password and exit `\q`
6. `sudo ./launcher enter app`
7. Update password in file `config/discourse.conf`
8. Restart rails: `rails restart`
9. Rebuild container or instance with new password
